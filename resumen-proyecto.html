<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Resumen - Sistema de Gesti√≥n de Eventos y Venta de Tickets</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
	<style>
		body { 
			font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; 
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			margin: 0;
			padding: 20px 0;
		}
		.container {
			background: white;
			border-radius: 20px;
			box-shadow: 0 20px 40px rgba(0,0,0,0.1);
			padding: 40px;
			margin: 20px auto;
		}
		h1 { 
			font-weight: 800; 
			color: #2c3e50;
			text-align: center;
			margin-bottom: 30px;
			font-size: 2.5rem;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
		}
		h2 { 
			font-weight: 700; 
			color: #34495e;
			border-bottom: 3px solid #3498db;
			padding-bottom: 10px;
			margin-top: 40px;
			margin-bottom: 20px;
		}
		h3 { 
			font-weight: 600; 
			color: #2c3e50;
			margin-top: 25px;
		}
		.small { 
			color: #7f8c8d; 
			font-size: 1.1rem;
			text-align: center;
		}
		li { 
			margin-bottom: 8px; 
			line-height: 1.6;
		}
		.code { 
			font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; 
			background: linear-gradient(45deg, #667eea, #764ba2);
			color: white;
			padding: 4px 8px; 
			border-radius: 8px; 
			font-weight: 600;
			box-shadow: 0 2px 4px rgba(0,0,0,0.2);
		}
		.badge-key { 
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			color: white;
			padding: 6px 12px;
			border-radius: 20px;
			font-weight: 600;
			display: inline-block;
			margin: 5px 0;
		}
		.section { 
			border-left: 5px solid #3498db; 
			padding-left: 20px; 
			margin-bottom: 30px;
			background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
			border-radius: 0 15px 15px 0;
			padding: 25px;
			box-shadow: 0 5px 15px rgba(0,0,0,0.08);
		}
		.table-sm td, .table-sm th { 
			padding: .5rem .75rem; 
		}
		.example { 
			background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
			border: 2px solid #2196f3; 
			border-radius: 15px; 
			padding: 20px; 
			margin: 15px 0;
			box-shadow: 0 4px 8px rgba(33, 150, 243, 0.2);
		}
		.example strong {
			color: #1565c0;
			font-size: 1.1rem;
		}
		pre {
			background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
			color: #ecf0f1;
			padding: 20px;
			border-radius: 12px;
			overflow-x: auto;
			box-shadow: 0 4px 8px rgba(0,0,0,0.3);
			margin: 15px 0;
		}
		pre code {
			color: #ecf0f1;
			font-size: 0.9rem;
			line-height: 1.5;
		}
		.emoji {
			font-size: 1.2em;
			margin-right: 8px;
		}
		.highlight {
			background: linear-gradient(45deg, #f39c12, #e67e22);
			color: white;
			padding: 3px 8px;
			border-radius: 6px;
			font-weight: 600;
		}
		.warning {
			background: linear-gradient(45deg, #e74c3c, #c0392b);
			color: white;
			padding: 15px;
			border-radius: 10px;
			margin: 15px 0;
			box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
		}
		.success {
			background: linear-gradient(45deg, #27ae60, #2ecc71);
			color: white;
			padding: 15px;
			border-radius: 10px;
			margin: 15px 0;
			box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
		}
		.info {
			background: linear-gradient(45deg, #3498db, #2980b9);
			color: white;
			padding: 15px;
			border-radius: 10px;
			margin: 15px 0;
			box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
		}
		ul, ol {
			padding-left: 25px;
		}
		ul li, ol li {
			margin-bottom: 10px;
		}
		.mb-0 {
			margin-bottom: 0 !important;
		}
		.mt-2 {
			margin-top: 15px !important;
		}
		.mb-4 {
			margin-bottom: 30px !important;
		}
		.py-4 {
			padding-top: 30px !important;
			padding-bottom: 30px !important;
		}
		.mb-1 {
			margin-bottom: 10px !important;
		}
		.mt-3 {
			margin-top: 20px !important;
		}
		.h4 {
			font-size: 1.5rem !important;
		}
		.h6 {
			font-size: 1.1rem !important;
		}
	</style>
</head>
<body class="container py-4">
	<header class="mb-4">
		<h1 class="mb-1">üéØ Resumen del Sistema</h1>
		<p class="small mb-0">üìã Proyecto: <span class="code">MesaAgostoRamosC</span> ‚Äî üöÄ Spring Boot 3, üé® Thymeleaf, üíæ JPA (MySQL)</p>
	</header>

	<section class="mb-4 section">
		<h2 class="h4">üéØ 1) Objetivo</h2>
		<p>Desarrollar un sistema web para gestionar <strong>Eventos Artisticos</strong>, <strong>Clientes</strong> y la <strong>venta de tickets</strong>. Los eventos se precargan y se muestran en la p√°gina inicial; se permite seleccionar cantidad de tickets, calcular total y registrar la compra. Se pueden <strong>crear/editar/eliminar</strong> clientes y consultar la <strong>recaudaci√≥n</strong> y los <strong>clientes compradores</strong>.</p>
		<div class="example mt-2">
			<strong>Historia de usuario (resumen):</strong> ‚ÄúComo cliente, quiero ver los eventos disponibles, seleccionar uno, elegir cu√°ntos tickets comprar, ver el total y confirmar la compra; como administrador, quiero gestionar clientes y ver la recaudaci√≥n.‚Äù
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">üèóÔ∏è 2) C√≥mo est√° organizado (Arquitectura + analog√≠a)</h2>
		<ul>
			<li><strong>Capa Presentaci√≥n</strong> (recibe clics y arma pantallas): Controladores en <span class="code">ar.edu.unju.fi.controller</span> y vistas Thymeleaf en <span class="code">src/main/resources/templates</span>.</li>
			<li><strong>Capa Negocio</strong> (reglas y decisiones): Servicios en <span class="code">ar.edu.unju.fi.service</span>.</li>
			<li><strong>Capa Datos</strong> (leer/escribir BD): Repositorios en <span class="code">ar.edu.unju.fi.repository</span>.</li>
			<li><strong>Capa Modelo</strong> (qu√© cosas existen): Entidades en <span class="code">ar.edu.unju.fi.model</span>.</li>
		</ul>
		<p class="mb-0"><span class="badge badge-key">Analog√≠a</span> Controlador = recepci√≥n, Servicio = oficina que decide, Repositorio = archivo/BD, Entidad = formulario con datos.</p>
		<div class="example mt-2">
			<strong>Flujo de una petici√≥n:</strong>
			<ol class="mb-0">
				<li>El usuario visita <span class="code">/eventos</span>.</li>
				<li>El <span class="code">EventoController</span> pide datos a <span class="code">EventoService</span>.</li>
				<li>El <span class="code">EventoService</span> usa <span class="code">EventoRepository</span> para consultar la BD.</li>
				<li>El <span class="code">Controller</span> arma el <span class="code">Model</span> y devuelve una vista Thymeleaf.</li>
				<li>Thymeleaf genera HTML con los datos (lista de eventos).</li>
			</ol>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">üìä 3) Entidades (clases) y sus atributos</h2>
		<h3 class="h6 mt-3">3.1 <span class="code">TipoEvento</span> (enum)</h3>
		<ul>
			<li>Valores fijos: <span class="code">RECITAL</span>, <span class="code">OBRA_DE_TEATRO</span>, <span class="code">STAND_UP</span>.</li>
		</ul>
		<h3 class="h6 mt-3">3.2 <span class="code">Evento</span></h3>
		<ul>
			<li><strong>nombre</strong> (texto, obligatorio)</li>
			<li><strong>descripcion</strong> (texto, obligatorio)</li>
			<li><strong>fecha</strong> (debe ser futura)</li>
			<li><strong>lugar</strong> (obligatorio)</li>
			<li><strong>precio</strong> (n√∫mero positivo)</li>
			<li><strong>capacidad</strong> (entero ‚â• 0). Disminuye con cada compra o se usa como total, seg√∫n el modelo elegido.</li>
			<li><strong>tipoEvento</strong> (enum)</li>
			<li><strong>capacidadInicial</strong> (valor original de capacidad)</li>
			<li><strong>compras</strong> (lista de compras asociadas)</li>
		</ul>
		<p class="mb-0">Relaci√≥n: un <strong>Evento</strong> puede tener muchas <strong>Compras</strong> (<em>OneToMany</em>), mapeadas en la tabla <span class="code">compras</span> por la FK <span class="code">evento_id</span>.</p>
		<div class="example mt-2">
			<strong>Ejemplo:</strong> Evento ‚ÄúColdplay‚Äù con <span class="code">capacidad = 50.000</span> y <span class="code">precio = 15.000</span>.
			<ul class="mb-0">
				<li>Un cliente compra 2 tickets ‚Üí total = 30.000.</li>
				<li>Disponibilidad (Modelo A) = 50.000 ‚àí vendidos.</li>
				<li>Disponibilidad (Modelo B) = valor actual de <span class="code">capacidad</span>.</li>
			</ul>
		</div>
		<div class="example mt-2">
			<strong>C√≥digo (fragmento de entidad Evento):</strong>
			<pre><code class="language-java">package ar.edu.unju.fi.model;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

import jakarta.persistence.*;
import jakarta.validation.constraints.*;
import org.springframework.format.annotation.DateTimeFormat;

@Entity
@Table(name = "eventos")
public class Evento {
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long id;

	@NotBlank
	@Column(nullable = false)
	private String nombre;

	@NotNull @Future
	@DateTimeFormat(pattern = "yyyy-MM-dd'T'HH:mm")
	@Column(nullable = false)
	private LocalDateTime fecha;

	@NotNull @Min(0)
	@Column(nullable = false)
	private Integer capacidad;

	@Enumerated(EnumType.STRING)
	@Column(nullable = false)
	private TipoEvento tipoEvento;

	@OneToMany(mappedBy = "evento", cascade = CascadeType.ALL, orphanRemoval = true)
	private List&lt;Compra&gt; compras = new ArrayList<>();
}
</code></pre>
		</div>
		<h3 class="h6 mt-3">3.3 <span class="code">Cliente</span></h3>
		<ul>
			<li><strong>nombre</strong>, <strong>apellido</strong> (obligatorios)</li>
			<li><strong>email</strong> (obligatorio y √∫nico)</li>
			<li><strong>dni</strong> (obligatorio y √∫nico)</li>
			<li><strong>compras</strong> (lista de compras del cliente)</li>
		</ul>
		<p class="mb-0">Relaci√≥n: un <strong>Cliente</strong> puede tener muchas <strong>Compras</strong> (<em>OneToMany</em>), mapeadas por la FK <span class="code">cliente_id</span>.</p>
		<h3 class="h6 mt-3">3.4 <span class="code">Compra</span></h3>
		<ul>
			<li><strong>cliente</strong> (<em>ManyToOne</em>)</li>
			<li><strong>evento</strong> (<em>ManyToOne</em>)</li>
			<li><strong>cantidadTickets</strong> (m√≠nimo 1)</li>
			<li><strong>total</strong> (precio √ó cantidad)</li>
			<li><strong>fechaCompra</strong> (autom√°tica)</li>
		</ul>
		<div class="example mt-2">
			<strong>Ciclo de vida de Compra:</strong>
			<ol class="mb-0">
				<li>Se valida que el evento exista y sea futuro.</li>
				<li>Se valida capacidad suficiente.</li>
				<li>Se calcula <span class="code">total</span>.</li>
				<li>Se guarda la compra y se ajusta disponibilidad (seg√∫n modelo elegido).</li>
			</ol>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">üóÑÔ∏è 4) Repositorios (acceso a datos)</h2>
		<h3 class="h6 mt-3"><span class="code">EventoRepository</span></h3>
		<ul>
			<li><span class="code">findByFechaAfterOrderByFechaAsc(...)</span>: eventos futuros ordenados.</li>
			<li><span class="code">findByNombreContainingIgnoreCase(...)</span>: b√∫squeda por nombre.</li>
			<li><span class="code">findEventosDisponibles(...)</span>: con fecha futura y capacidad disponible (usa subconsulta en JPQL).</li>
			<li><span class="code">getTicketsVendidos(eventoId)</span>: suma de tickets vendidos (JPQL con <span class="code">SUM</span> y <span class="code">COALESCE</span>).</li>
			<li><span class="code">getRecaudacionPorEvento()</span>, <span class="code">getRecaudacionPorTipoEvento()</span>: sumas de dinero agrupadas (<span class="code">GROUP BY</span>).</li>
		</ul>
		<div class="example mt-2">
			<strong>Convenci√≥n de Spring Data:</strong> <span class="code">findByXAndYOrderByZAsc</span> crea consultas autom√°ticamente a partir del nombre del m√©todo.
		</div>
		<div class="example mt-2">
			<strong>C√≥digo (EventoRepository - consultas JPQL):</strong>
			<pre><code class="language-java">@Query("SELECT e FROM Evento e WHERE e.fecha &gt; :fecha AND e.capacidad &gt; (SELECT COALESCE(SUM(c.cantidadTickets), 0) FROM Compra c WHERE c.evento = e)")
List&lt;Evento&gt; findEventosDisponibles(@Param("fecha") LocalDateTime fecha);

@Query("SELECT e.nombre, COALESCE(SUM(c.total), 0) FROM Evento e LEFT JOIN e.compras c GROUP BY e.id, e.nombre ORDER BY SUM(c.total) DESC")
List&lt;Object[]&gt; getRecaudacionPorEvento();
</code></pre>
		</div>
		<h3 class="h6 mt-3"><span class="code">ClienteRepository</span></h3>
		<ul>
			<li><span class="code">findByEmail(...)</span>, <span class="code">findByDni(...)</span>: b√∫squeda por campos √∫nicos.</li>
			<li><span class="code">findClientesConCompras()</span>: usa <span class="code">JOIN FETCH</span> para traer clientes con sus compras evitando el problema N+1.</li>
		</ul>
		<h3 class="h6 mt-3"><span class="code">CompraRepository</span></h3>
		<ul>
			<li><span class="code">findByClienteOrderByFechaCompraDesc(...)</span>, <span class="code">findByEventoOrderByFechaCompraDesc(...)</span>.</li>
			<li><span class="code">countTicketsVendidosPorEvento(eventoId)</span>: suma de tickets vendidos.</li>
			<li><span class="code">findRecaudacionPorEvento()</span>: suma de dinero por evento.</li>
		</ul>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">‚öôÔ∏è 5) Servicios (l√≥gica de negocio)</h2>
		<h3 class="h6 mt-3"><span class="code">EventoService</span></h3>
		<ul>
			<li><span class="code">listarEventos()</span>, <span class="code">listarEventosDisponibles()</span>, <span class="code">listarEventosPorTipo(...)</span>.</li>
			<li><span class="code">guardarEvento(evento)</span>: valida capacidad (no negativa, ni menor a lo vendido) y setea <span class="code">capacidadInicial</span> si falta.</li>
			<li><span class="code">obtenerEventoPorId(id)</span>, <span class="code">eliminar(id)</span>.</li>
			<li><span class="code">obtenerTicketsDisponibles(eventoId)</span>: <em>capacidad</em> ‚àí <em>vendidos</em> (Modelo A) o lee <em>remanente</em> (Modelo B).</li>
			<li><span class="code">obtenerRecaudacionPorEvento()</span>, <span class="code">obtenerRecaudacionPorTipoEvento()</span>.</li>
		</ul>
		<div class="example mt-2">
			<strong>@Transactional:</strong> asegura que operaciones relacionadas (por ejemplo, validar y guardar un evento) se ejecuten de forma at√≥mica.
		</div>
		<h3 class="h6 mt-3"><span class="code">ClienteService</span></h3>
		<ul>
			<li><span class="code">listarClientes()</span>, <span class="code">listarClientesConCompras()</span>.</li>
			<li><span class="code">guardarCliente(cliente)</span>: valida <strong>email</strong> y <strong>DNI</strong> √∫nicos (a nivel de servicio, adem√°s del √≠ndice √∫nico en BD).</li>
			<li><span class="code">obtenerClientePorId(id)</span>, <span class="code">actualizarCliente(id, datos)</span>.</li>
			<li><span class="code">eliminarCliente(id)</span>: solo si no tiene compras (para mantener coherencia de datos).</li>
		</ul>
		<h3 class="h6 mt-3"><span class="code">CompraService</span></h3>
		<ul>
			<li><span class="code">listarCompras()</span>.</li>
			<li><span class="code">guardar(compra)</span>:
				<ul>
					<li>Valida que el evento exista y sea futuro.</li>
					<li>Revisa disponibilidad (seg√∫n modelo).</li>
					<li>Calcula <span class="code">total = precio √ó cantidad</span>.</li>
					<li>Guarda la compra y ajusta disponibilidad (si Modelo B).</li>
				</ul>
			</li>
			<li><span class="code">actualizarCompra(compra)</span>: recalcula diferencia de tickets respecto a la compra anterior y ajusta la disponibilidad.</li>
			<li><span class="code">eliminar(id)</span>: devuelve tickets a la capacidad del evento (si Modelo B) y borra la compra.</li>
			<li><span class="code">obtenerCompraPorId(id)</span>, <span class="code">obtenerTicketsDisponibles(eventoId)</span>.</li>
		</ul>
		<div class="example mt-2">
			<strong>C√≥digo (CompraService.guardar):</strong>
			<pre><code class="language-java">@Transactional
public Compra guardar(Compra compra) {
	Evento evento = compra.getEvento();
	if (evento == null || evento.getId() == null) {
		throw new RuntimeException("Evento no v√°lido");
	}
	if (evento.getFecha().isBefore(LocalDateTime.now())) {
		throw new RuntimeException("El evento ya ha finalizado");
	}
	if (evento.getCapacidad() &lt; compra.getCantidadTickets()) {
		throw new RuntimeException("No hay suficientes tickets disponibles");
	}
	compra.setFechaCompra(LocalDateTime.now());
	compra.setTotal(evento.getPrecio() * compra.getCantidadTickets());
	compraRepository.save(compra);
	// Modelo B: ajustar remanente
	evento.setCapacidad(evento.getCapacidad() - compra.getCantidadTickets());
	eventoRepository.save(evento);
	return compra;
}
</code></pre>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">üéÆ 6) Controladores (pantallas y rutas)</h2>
		<h3 class="h6 mt-3"><span class="code">IndexController</span></h3>
		<ul>
			<li><span class="code">GET /</span>: carga eventos, clientes y compras en la p√°gina de inicio.</li>
		</ul>
		<h3 class="h6 mt-3"><span class="code">EventoController</span> (<span class="code">/eventos</span>)</h3>
		<ul>
			<li><span class="code">GET /eventos</span>: lista eventos disponibles.</li>
			<li><span class="code">GET /eventos/nuevo</span> y <span class="code">POST /eventos/nuevo</span>: alta de evento (usa <span class="code">@Valid</span> y muestra errores con <span class="code">BindingResult</span>).</li>
			<li><span class="code">GET /eventos/evento/detalle/{id}</span>: detalle del evento + tickets disponibles.</li>
			<li><span class="code">GET /eventos/editar/{id}</span>, <span class="code">GET/POST /eventos/eliminar/{id}</span>.</li>
			<li><span class="code">GET /eventos/recaudacion</span>: recaudaci√≥n por evento y por tipo.</li>
			<li><span class="code">GET /eventos/clientes-compras</span>: clientes que realizaron compras.</li>
		</ul>
		<h3 class="h6 mt-3"><span class="code">ClienteController</span> (<span class="code">/clientes</span>)</h3>
		<ul>
			<li><span class="code">GET /clientes</span>, <span class="code">GET /clientes/nuevo</span>, <span class="code">POST /clientes/guardar</span>, <span class="code">GET /clientes/editar/{id}</span>, <span class="code">POST /clientes/eliminar/{id}</span>, <span class="code">GET /clientes/compradores</span>.</li>
		</ul>
		<h3 class="h6 mt-3"><span class="code">CompraController</span> (<span class="code">/compras</span>)</h3>
		<ul>
			<li><span class="code">GET /compras</span>, <span class="code">GET /compras/nueva</span>, <span class="code">GET /compras/nuevo/{eventoId}</span>.</li>
			<li><span class="code">POST /compras/guardar</span>: crea o actualiza compra (si hay errores, vuelve al formulario; si todo ok, <em>PRG pattern</em>: <strong>Post/Redirect/Get</strong>).</li>
			<li><span class="code">POST /compras/eliminar/{id}</span>, <span class="code">GET /compras/compra/detalle/{id}</span>, <span class="code">GET /compras/editar/{id}</span>, <span class="code">GET /compras/recaudacion</span>.</li>
		</ul>
		<div class="example mt-2">
			<strong>C√≥digo (CompraController.guardarCompra):</strong>
			<pre><code class="language-java">@PostMapping("/guardar")
public String guardarCompra(@Valid @ModelAttribute Compra compra,
		BindingResult result, Model model, RedirectAttributes redirectAttributes) {
	if (result.hasErrors()) {
		model.addAttribute("eventos", eventoService.listarEventos());
		model.addAttribute("clientes", clienteService.listarClientes());
		return "compras/form";
	}
	try {
		if (compra.getId() != null) {
			compraService.actualizarCompra(compra);
		} else {
			compraService.guardar(compra);
		}
		redirectAttributes.addFlashAttribute("success", "Compra guardada exitosamente.");
	} catch (RuntimeException e) {
		model.addAttribute("eventos", eventoService.listarEventos());
		model.addAttribute("clientes", clienteService.listarClientes());
		model.addAttribute("error", e.getMessage());
		return "compras/form";
	}
	return "redirect:/compras";
}
</code></pre>
		</div>
		<div class="example mt-2">
			<strong>Formularios y errores:</strong> si <span class="code">BindingResult</span> tiene errores de validaci√≥n, se vuelve a mostrar la misma vista con mensajes; si no, se redirige para evitar reenv√≠os.
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">üé® 7) Vistas (Thymeleaf)</h2>
		<ul>
			<li><strong>Templates</strong> en <span class="code">src/main/resources/templates</span>. Usan variables como <span class="code">${eventos}</span> para mostrar datos.</li>
			<li><strong>Index.html</strong>: tarjetas con cada evento, bot√≥n <em>Comprar</em> (desactivado si capacidad = 0).</li>
			<li>Otras vistas: formularios y listados en <span class="code">eventos</span>, <span class="code">clientes</span>, <span class="code">compras</span>.</li>
		</ul>
		<div class="example mt-2">
			<strong>Expresiones Thymeleaf √∫tiles:</strong>
			<ul class="mb-0">
				<li><span class="code">th:each</span> (iterar), <span class="code">th:text</span> (texto), <span class="code">th:href</span> (enlaces), <span class="code">th:disabled</span> (deshabilitar).</li>
				<li>Utilidades: <span class="code">#strings.abbreviate(...)</span>, <span class="code">#temporals.format(...)</span> para fechas.</li>
			</ul>
		</div>
		<div class="example mt-2">
			<strong>C√≥digo (fragmento Thymeleaf):</strong>
			<pre><code class="language-html">&lt;div th:each="evento : ${eventos}" class="card"&gt;
  &lt;h5 th:text="${evento.nombre}"&gt;Nombre&lt;/h5&gt;
  &lt;p th:text="${#strings.abbreviate(evento.descripcion, 100)}"&gt;Descripci√≥n&lt;/p&gt;
  &lt;span th:text="${#temporals.format(evento.fecha, 'dd/MM/yyyy HH:mm')}"&gt;Fecha&lt;/span&gt;
  &lt;a th:href="@{/compras/nueva/{eventoId}(eventoId=${evento.id})}" class="btn btn-success"
     th:disabled="${evento.capacidad == 0}"&gt;Comprar&lt;/a&gt;
&lt;/div&gt;
</code></pre>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">8) Persistencia y datos iniciales</h2>
		<ul>
			<li><strong>Base de datos</strong> MySQL (configurada en <span class="code">application.properties</span> con <span class="code">ddl-auto=update</span>).</li>
			<li><strong>DataLoader</strong>: si no hay eventos, precarga 6 con fechas futuras y capacidad inicial.</li>
		</ul>
		<div class="example mt-2">
			<strong>Mapeo a tablas:</strong> <span class="code">eventos</span>, <span class="code">clientes</span>, <span class="code">compras</span>. En <span class="code">compras</span> existen <span class="code">cliente_id</span> y <span class="code">evento_id</span> como claves for√°neas.
		</div>
		<div class="example mt-2">
			<strong>C√≥digo (application.properties):</strong>
			<pre><code class="language-properties">spring.datasource.url=jdbc:mysql://localhost:3306/mesapv
spring.datasource.username=root
spring.datasource.password=mesapv
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
</code></pre>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">9) Excepciones personalizadas</h2>
		<ul>
			<li><span class="code">EventoNoEncontradoException</span>: cuando un evento no existe.</li>
			<li><span class="code">InvalidCapacityException</span>: cuando se quiere poner una capacidad inv√°lida.</li>
		</ul>
		<div class="example mt-2">
			<strong>C√≥mo se muestran al usuario:</strong> los controladores capturan errores, agregan <span class="code">model.addAttribute("error", ...)</span> y muestran una vista de error o el formulario con el mensaje.
		</div>
		<div class="example mt-2">
			<strong>C√≥digo (excepciones personalizadas):</strong>
			<pre><code class="language-java">public class EventoNoEncontradoException extends RuntimeException {
	public EventoNoEncontradoException(String message) { super(message); }
}
</code></pre>
			<pre><code class="language-java">public class InvalidCapacityException extends RuntimeException {
	public InvalidCapacityException(String message) { super(message); }
}
</code></pre>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">10) Flujo de compra (paso a paso)</h2>
		<ol>
			<li>Inicio <span class="code">GET /</span>: se muestran eventos.</li>
			<li>Eleg√≠s un evento y vas a <span class="code">/compras/nuevo/{eventoId}</span>.</li>
			<li>Seleccion√°s cliente y cantidad de tickets.</li>
			<li>Al guardar: se valida fecha futura, capacidad, se calcula <em>total</em>, se guarda la compra y se ajusta disponibilidad.</li>
			<li>Si elimin√°s la compra: se devuelven esos tickets a la capacidad del evento (Modelo B).</li>
		</ol>
		<div class="example mt-2">
			<strong>Escenarios:</strong>
			<ul class="mb-0">
				<li><em>Compra v√°lida</em>: se confirma y aparece ‚ÄúCompra guardada exitosamente‚Äù.</li>
				<li><em>Sin capacidad</em>: se muestra error y se mantiene el formulario.</li>
				<li><em>Evento pasado</em>: se bloquea con mensaje ‚ÄúEl evento ya ha finalizado‚Äù.</li>
			</ul>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">11) Reglas de negocio y validaciones</h2>
		<ul>
			<li>Eventos: fecha futura; capacidad no negativa; no reducir por debajo de lo vendido.</li>
			<li>Compras: solo si hay capacidad y el evento no termin√≥; total = precio √ó cantidad.</li>
			<li>Clientes: email y DNI √∫nicos; no se eliminan si tienen compras.</li>
			<li>Eliminar compra: devuelve tickets a la capacidad del evento (Modelo B).</li>
		</ul>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">üìö 12) Glosario (en simple)</h2>
		<ul>
			<li><strong>Entidad</strong>: ‚Äúcosa‚Äù que se guarda en BD (Evento, Cliente, Compra).</li>
			<li><strong>Repositorio</strong>: puerta para leer/escribir en BD (sin SQL manual).</li>
			<li><strong>Servicio</strong>: cerebro con reglas (valida, calcula, coordina).</li>
			<li><strong>Controlador</strong>: recepci√≥n web (elige la vista y env√≠a datos).</li>
			<li><strong>Validaci√≥n</strong>: reglas para evitar datos inv√°lidos (precio > 0, etc.).</li>
			<li><strong>Transacci√≥n</strong>: operaci√≥n que se hace completa o se deshace (consistencia).</li>
			<li><strong>ORM</strong>: mapeo objeto-relacional (JPA/Hibernate).</li>
			<li><strong>JPQL</strong>: lenguaje de consultas orientado a entidades (no a tablas).</li>
			<li><strong>DDL/DML</strong>: DDL = estructura (crear tablas), DML = datos (insertar/actualizar).</li>
		</ul>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">‚ùì 13) Preguntas frecuentes (FAQ)</h2>
		<ul>
			<li><strong>¬øC√≥mo se evita vender m√°s de la capacidad?</strong> El servicio compara los tickets pedidos con la capacidad disponible antes de guardar.</li>
			<li><strong>¬øPor qu√© no puedo reducir la capacidad libremente?</strong> Para no quedar por debajo de lo ya vendido, el servicio lo impide.</li>
			<li><strong>¬øC√≥mo se calcula la recaudaci√≥n?</strong> Sumando el <em>total</em> de todas las compras por evento o por tipo.</li>
			<li><strong>¬øQu√© pasa si borro una compra?</strong> Se suman esos tickets de nuevo a la capacidad del evento.</li>
			<li><strong>¬øPor qu√© no puedo borrar un cliente con compras?</strong> Para preservar el historial de ventas y la coherencia.</li>
			<li><strong>¬øD√≥nde se fija la conexi√≥n a la BD?</strong> En <span class="code">application.properties</span>.</li>
			<li><strong>¬øQu√© es <span class="code">capacidadInicial</span>?</strong> El valor original de la capacidad (√∫til como referencia hist√≥rica).</li>
		</ul>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">‚ö†Ô∏è 14) Modelo de capacidad (consistencia)</h2>
		<p>Hay dos formas de interpretar <span class="code">capacidad</span>. Debes elegir UNA y ser consistente:</p>
		<ul>
			<li><strong>Modelo A (recomendado)</strong>: <span class="code">capacidad</span> = total original. Los tickets <em>disponibles</em> se calculan como <span class="code">capacidad ‚àí vendidos</span>. En este modelo, <strong>no se modifica</strong> <span class="code">evento.capacidad</span> al comprar/eliminar; solo se registran compras y se consulta lo vendido para calcular disponibilidad.</li>
			<li><strong>Modelo B (alternativo)</strong>: <span class="code">capacidad</span> = remanente. En este modelo, al comprar <strong>se resta</strong> a <span class="code">capacidad</span> y al eliminar compra <strong>se suma</strong>. Las consultas no deben volver a restar lo vendido.</li>
		</ul>
		<div class="warning">
			<strong>üö® Sugerencia de defensa</strong>: Explica que usar√°s el <strong>Modelo A</strong> porque simplifica la l√≥gica y cuadra con las consultas existentes (disponible = total ‚àí vendidos). Si te preguntan c√≥mo corregir, di que en <span class="code">CompraService</span> no se debe modificar <span class="code">evento.capacidad</span> al guardar/eliminar, y que <span class="code">EventoRepository.findEventosDisponibles</span> se mantiene como est√°.
		</div>
		<div class="example mt-2">
			<strong>Ejemplo num√©rico (Modelo A):</strong> Capacidad 100, vendidos 30 ‚Üí disponibles 70. Se compra 5 ‚Üí vendidos 35, disponibles 65 (la columna <span class="code">capacidad</span> no cambia).
		</div>
		<div class="example mt-2">
			<strong>C√≥digo (EventoService.obtenerTicketsDisponibles):</strong>
			<pre><code class="language-java">public int obtenerTicketsDisponibles(Long eventoId) {
	Evento evento = obtenerEventoPorId(eventoId);
	int ticketsVendidos = eventoRepository.getTicketsVendidos(eventoId);
	return evento.getCapacidad() - ticketsVendidos;
}
</code></pre>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">‚ö° 15) Concurrencia (compras simult√°neas)</h2>
		<p>Si dos usuarios compran al mismo tiempo, puede haber sobreventa si ambos leen disponibilidad antes de que uno confirme. Estrategias:</p>
		<ul>
			<li><strong>Bloqueo optimista</strong>: agregar <span class="code">@Version</span> a <span class="code">Evento</span> y detectar conflictos al guardar.</li>
			<li><strong>Bloqueo pesimista</strong>: usar consultas con bloqueo a nivel de BD (por ejemplo, <em>select for update</em>).</li>
			<li><strong>Verificaci√≥n final en transacci√≥n</strong>: re-chequear disponibilidad justo antes de confirmar dentro de <span class="code">@Transactional</span>.</li>
		</ul>
		<p>En la defensa, explica qu√© elegir√≠as y por qu√© (optimista suele ser suficiente y escalable).</p>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">16) Actuator y herramientas de desarrollo</h2>
		<ul>
			<li><strong>Actuator</strong>: expone endpoints de monitoreo (ej.: <span class="code">/actuator/health</span>).</li>
			<li><strong>Devtools</strong>: recarga en caliente para desarrollo.</li>
		</ul>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">18) Preguntas de examen (extra)</h2>
		<ul>
			<li><strong>¬øDiferencia entre <span class="code">@Controller</span> y <span class="code">@RestController</span>?</strong> Vista HTML vs JSON.</li>
			<li><strong>¬øPor qu√© mapear enum con <span class="code">EnumType.STRING</span>?</strong> Es legible y no se rompe si cambia el orden del enum.</li>
			<li><strong>¬øQu√© implica <span class="code">LAZY</span>?</strong> Carga diferida de relaciones para mejorar rendimiento.</li>
			<li><strong>¬øCu√°ndo usar <span class="code">@Query</span>?</strong> Cuando necesitas JPQL personalizado m√°s all√° de los <em>query methods</em>.</li>
			<li><strong>¬øEs recomendable <span class="code">ddl-auto=update</span> en producci√≥n?</strong> No; usar migraciones (Flyway/Liquibase).</li>
		</ul>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">19) Validaciones en c√≥digo (ejemplo)</h2>
		<div class="example mt-2">
			<strong>C√≥digo (Compra con validaciones):</strong>
			<pre><code class="language-java">@Entity
@Table(name = "compras")
public class Compra {
	@Id @GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long id;

	@NotNull(message = "El cliente es obligatorio")
	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "cliente_id", nullable = false)
	private Cliente cliente;

	@NotNull(message = "El evento es obligatorio")
	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "evento_id", nullable = false)
	private Evento evento;

	@NotNull @Min(1)
	@Column(nullable = false)
	private Integer cantidadTickets;

	@Positive
	@Column(nullable = false)
	private Double total;
}
</code></pre>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">20) Rutas clave (resumen)</h2>
		<ul>
			<li><span class="code">GET /</span> (inicio)</li>
			<li><span class="code">/eventos</span>: listar, crear (<span class="code">/nuevo</span>), editar, eliminar, detalle (<span class="code">/evento/detalle/{id}</span>), recaudaci√≥n, clientes-compras</li>
			<li><span class="code">/clientes</span>: listar, crear (<span class="code">/nuevo</span>), guardar, editar, eliminar, compradores</li>
			<li><span class="code">/compras</span>: listar, nueva (<span class="code">/nueva</span> o <span class="code">/nuevo/{eventoId}</span>), guardar, eliminar, detalle, editar, recaudaci√≥n</li>
		</ul>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">üöÄ 21) Ejecuci√≥n local (c√≥mo correr)</h2>
		<ol>
			<li>Crear BD MySQL: <span class="code">mesapv</span> y ajustar credenciales en <span class="code">application.properties</span>.</li>
			<li>En consola: <span class="code">mvn spring-boot:run</span> (o ejecutar la clase <span class="code">MesaAgostoRamosCApplication</span> desde IDE).</li>
			<li>Abrir <span class="code">http://localhost:8080/</span>.</li>
		</ol>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">22) Eliminaciones y cascada</h2>
		<p>En <span class="code">Evento</span> y <span class="code">Cliente</span>, la relaci√≥n hacia <span class="code">Compra</span> usa <span class="code">cascade = CascadeType.ALL</span> y <span class="code">orphanRemoval = true</span>. Esto implica que al eliminar un evento/cliente, tambi√©n se eliminan sus compras asociadas.</p>
		<div class="example mt-2">
			<pre><code class="language-java">@OneToMany(mappedBy = "evento", cascade = CascadeType.ALL, orphanRemoval = true)
private List&lt;Compra&gt; compras = new ArrayList<>();
</code></pre>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">üõ†Ô∏è 23) Stack y versiones</h2>
		<ul>
			<li><strong>Java</strong>: 17</li>
			<li><strong>Spring Boot</strong>: 3.2.3</li>
			<li><strong>Base de datos</strong>: MySQL 8 (dialecto <span class="code">MySQL8Dialect</span>)</li>
			<li><strong>Plantillas</strong>: Thymeleaf</li>
			<li><strong>Frontend</strong>: Bootstrap 5.3.3, jQuery 3.7.1, Popper 2.11.7</li>
			<li><strong>Lombok</strong>: 1.18.38 (incluida; no se usa en entidades actuales)</li>
		</ul>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">üè∑Ô∏è 24) Anotaciones clave explicadas</h2>
		<div class="example mt-2">
			<strong>Anotaciones de Entidad:</strong>
			<ul class="mb-0">
				<li><span class="code">@Entity</span>: Marca la clase como entidad JPA que se mapea a una tabla.</li>
				<li><span class="code">@Table(name = "eventos")</span>: Especifica el nombre de la tabla en la BD.</li>
				<li><span class="code">@Id @GeneratedValue(strategy = GenerationType.IDENTITY)</span>: Clave primaria autoincremental.</li>
				<li><span class="code">@Column(nullable = false)</span>: La columna no puede ser NULL en la BD.</li>
				<li><span class="code">@Enumerated(EnumType.STRING)</span>: Guarda el enum como texto (ej: "RECITAL") en lugar de n√∫mero.</li>
			</ul>
		</div>
		<div class="example mt-2">
			<strong>Anotaciones de Relaci√≥n:</strong>
			<ul class="mb-0">
				<li><span class="code">@OneToMany(mappedBy = "evento")</span>: Un evento puede tener muchas compras. <span class="code">mappedBy</span> indica que la FK est√° en la tabla <span class="code">compras</span>.</li>
				<li><span class="code">@ManyToOne(fetch = FetchType.LAZY)</span>: Muchas compras pertenecen a un evento. <span class="code">LAZY</span> carga el evento solo cuando se accede.</li>
				<li><span class="code">@JoinColumn(name = "evento_id")</span>: Especifica el nombre de la columna FK.</li>
			</ul>
		</div>
		<div class="example mt-2">
			<strong>Anotaciones de Validaci√≥n:</strong>
			<ul class="mb-0">
				<li><span class="code">@NotBlank</span>: String no puede estar vac√≠o o ser solo espacios.</li>
				<li><span class="code">@NotNull</span>: Campo no puede ser null.</li>
				<li><span class="code">@Email</span>: Valida formato de email.</li>
				<li><span class="code">@Min(1)</span>: Valor m√≠nimo 1.</li>
				<li><span class="code">@Positive</span>: Debe ser mayor a 0.</li>
				<li><span class="code">@Future</span>: Fecha debe ser futura.</li>
			</ul>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">25) Ciclo de vida de una petici√≥n HTTP</h2>
		<div class="example mt-2">
			<strong>Flujo completo:</strong>
			<ol class="mb-0">
				<li><strong>Cliente env√≠a petici√≥n</strong> (ej: GET /eventos)</li>
				<li><strong>Spring MVC recibe</strong> y busca el controlador que mapee esa URL</li>
				<li><strong>Controller ejecuta m√©todo</strong> (ej: listarEventos())</li>
				<li><strong>Service procesa l√≥gica</strong> de negocio</li>
				<li><strong>Repository consulta BD</strong> y devuelve datos</li>
				<li><strong>Service devuelve resultado</strong> al Controller</li>
				<li><strong>Controller arma Model</strong> con datos para la vista</li>
				<li><strong>Thymeleaf renderiza</strong> HTML con los datos</li>
				<li><strong>Se devuelve respuesta</strong> HTTP al cliente</li>
			</ol>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">26) Manejo de formularios y validaci√≥n</h2>
		<div class="example mt-2">
			<strong>Patr√≥n t√≠pico en controladores:</strong>
			<pre><code class="language-java">@PostMapping("/guardar")
public String guardarCliente(@Valid @ModelAttribute("cliente") Cliente cliente, 
                            BindingResult result, Model model, 
                            RedirectAttributes redirectAttributes) {
    if (result.hasErrors()) {
        // Hay errores de validaci√≥n, volver al formulario
        return "clientes/form";
    }
    
    try {
        clienteService.guardarCliente(cliente);
        redirectAttributes.addFlashAttribute("success", "Cliente guardado con √©xito");
        return "redirect:/clientes"; // PRG Pattern
    } catch (Exception e) {
        model.addAttribute("error", e.getMessage());
        return "clientes/form";
    }
}
</code></pre>
		</div>
		<div class="example mt-2">
			<strong>En Thymeleaf (mostrar errores):</strong>
			<pre><code class="language-html">&lt;form th:action="@{/clientes/guardar}" th:object="${cliente}" method="post"&gt;
    &lt;input th:field="*{nombre}" type="text" /&gt;
    &lt;span th:if="${#fields.hasErrors('nombre')}" 
          th:errors="*{nombre}" class="error"&gt;&lt;/span&gt;
    
    &lt;input th:field="*{email}" type="email" /&gt;
    &lt;span th:if="${#fields.hasErrors('email')}" 
          th:errors="*{email}" class="error"&gt;&lt;/span&gt;
    
    &lt;button type="submit"&gt;Guardar&lt;/button&gt;
&lt;/form&gt;
</code></pre>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">27) Transacciones y consistencia</h2>
		<div class="example mt-2">
			<strong>¬øPor qu√© usar @Transactional?</strong>
			<ul class="mb-0">
				<li><strong>Atomicidad:</strong> O todas las operaciones se ejecutan, o ninguna.</li>
				<li><strong>Consistencia:</strong> La BD queda en un estado v√°lido.</li>
				<li><strong>Aislamiento:</strong> Las transacciones no interfieren entre s√≠.</li>
				<li><strong>Durabilidad:</strong> Los cambios se guardan permanentemente.</li>
			</ul>
		</div>
		<div class="example mt-2">
			<strong>Ejemplo en CompraService:</strong>
			<pre><code class="language-java">@Transactional
public Compra guardar(Compra compra) {
    // 1. Validar disponibilidad
    if (evento.getCapacidad() < compra.getCantidadTickets()) {
        throw new RuntimeException("No hay suficientes tickets");
    }
    
    // 2. Calcular total
    compra.setTotal(evento.getPrecio() * compra.getCantidadTickets());
    
    // 3. Guardar compra
    compraRepository.save(compra);
    
    // 4. Actualizar capacidad del evento
    evento.setCapacidad(evento.getCapacidad() - compra.getCantidadTickets());
    eventoRepository.save(evento);
    
    // Si algo falla en cualquier paso, TODO se revierte
    return compra;
}
</code></pre>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">28) Problemas comunes y soluciones</h2>
		<div class="example mt-2">
			<strong>Problema N+1:</strong>
			<ul class="mb-0">
				<li><strong>S√≠ntoma:</strong> Muchas consultas SQL para cargar relaciones.</li>
				<li><strong>Soluci√≥n:</strong> Usar <span class="code">JOIN FETCH</span> en consultas JPQL.</li>
				<li><strong>Ejemplo:</strong> <span class="code">@Query("SELECT DISTINCT c FROM Cliente c JOIN FETCH c.compras")</span></li>
			</ul>
		</div>
		<div class="example mt-2">
			<strong>LazyInitializationException:</strong>
			<ul class="mb-0">
				<li><strong>Causa:</strong> Acceder a relaciones LAZY fuera de transacci√≥n.</li>
				<li><strong>Soluci√≥n:</strong> Usar <span class="code">@Transactional</span> o cambiar a <span class="code">EAGER</span>.</li>
			</ul>
		</div>
		<div class="example mt-2">
			<strong>Reenv√≠o de formularios:</strong>
			<ul class="mb-0">
				<li><strong>Problema:</strong> Usuario refresca p√°gina y reenv√≠a POST.</li>
				<li><strong>Soluci√≥n:</strong> Patr√≥n PRG (Post/Redirect/Get).</li>
			</ul>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">29) M√©tricas y monitoreo</h2>
		<div class="example mt-2">
			<strong>Actuator endpoints disponibles:</strong>
			<ul class="mb-0">
				<li><span class="code">/actuator/health</span>: Estado de la aplicaci√≥n</li>
				<li><span class="code">/actuator/info</span>: Informaci√≥n de la app</li>
				<li><span class="code">/actuator/metrics</span>: M√©tricas de rendimiento</li>
				<li><span class="code">/actuator/env</span>: Variables de entorno</li>
			</ul>
		</div>
	</section>

	<section class="mb-4 section">
		<h2 class="h4">üèÜ 30) Resumen final para la defensa</h2>
		<div class="example mt-2">
			<strong>Puntos clave que demuestran dominio:</strong>
			<ol class="mb-0">
				<li><strong>Arquitectura MVC:</strong> Separaci√≥n clara de responsabilidades entre capas.</li>
				<li><strong>Validaciones robustas:</strong> Bean Validation + reglas de negocio personalizadas.</li>
				<li><strong>Transacciones:</strong> Uso correcto de @Transactional para consistencia.</li>
				<li><strong>Relaciones JPA:</strong> Mapeo correcto de OneToMany y ManyToOne.</li>
				<li><strong>Manejo de errores:</strong> Excepciones personalizadas y mensajes al usuario.</li>
				<li><strong>Experiencia de usuario:</strong> Flujo intuitivo de compra con validaciones.</li>
				<li><strong>Reportes:</strong> Funcionalidad de recaudaci√≥n y an√°lisis.</li>
				<li><strong>Configuraci√≥n:</strong> Base de datos, propiedades y carga inicial.</li>
			</ol>
		</div>
		<div class="success">
			<strong>üí¨ Frase de cierre:</strong> "Este proyecto demuestra una comprensi√≥n s√≥lida de Spring Boot, JPA, Thymeleaf y patrones de dise√±o web, implementando un sistema funcional con validaciones, transacciones y una arquitectura escalable."
		</div>
	</section>

</body>

</html> 
